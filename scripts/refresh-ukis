#!/usr/bin/env bash
# =============================================================================
# Refresh Snapshot UKIs
# =============================================================================
# Called by snapper-boot-entries.service to regenerate snapshot UKIs after snapshots are added or deleted..
# This ensures bootable snapshot entries are always up to date.
#
# Installed to: /usr/local/bin/refresh-snapshot-ukis
# =============================================================================

set -euo pipefail

SNAPSHOT_MANAGER="/usr/local/bin/manage-ukis"
LOG_FILE="/var/log/sdboot-snaps-refresh.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

### Check if the script is being run with root privileges
   if ((EUID != 0)); then
        echo "Script must be run with root privileges."
		exit 1
	fi

## check if manager is already running
#if pgrep -f "manage-ukis" &>/dev/null; then
#    log "manage-ukis is already running"
#    exit 0
#fi

# find the snapshot manager script
if [ -x "$SNAPSHOT_MANAGER" ]; then
    MANAGER="$SNAPSHOT_MANAGER"
else
    log "Warning: Snapshot UKI manager not found, skipping refresh"
    exit 0
fi

# check if snapshots exist
if [ ! -d "/.snapshots" ] || [ -z "$(ls -A /.snapshots 2>/dev/null)" ]; then
    log "No snapshots found in /.snapshots, skipping UKI refresh"
    exit 0
fi

log "Refreshing snapshot UKIs after snapshot updates/deletions..."

# refresh with default count (7) or config count
if "$MANAGER" refresh 2>&1; then
    log "Snapshot UKIs refreshed successfully"
else
    log "Warning: Failed to refresh some snapshot UKIs"
    # don't fail the hook - kernel update should still succeed
fi

exit 0
