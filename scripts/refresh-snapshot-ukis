#!/usr/bin/env bash
# =============================================================================
# Refresh Snapshot UKIs
# =============================================================================
# Called by snapper-boot-entries.service to regenerate snapshot UKIs after snapshots are added or deleted..
# This ensures bootable snapshot entries are always up to date.
#
# Installed to: /usr/local/bin/refresh-snapshot-ukis
# =============================================================================

set -euo pipefail

SNAPSHOT_MANAGER="/usr/local/bin/manage-snapshot-ukis"
LOG_FILE="/var/log/snapshot-uki-refresh.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

### Check if the script is being run with root privileges
require_root() {
	if ((EUID != 0)); then
		echo "Script must be run with root privileges."
		exit 1
	fi
}

### Check if you are not in Btrfs.
require_btrfs_root() {
	local fstype
	read -r fstype < <(findmnt --mountpoint / -no FSTYPE)
	if [[ "$fstype" != "btrfs" ]]; then
		log "Root filesystem is not Btrfs. Script stopped."
		exit 0
	fi
}

is_btrfs_ro() {
	[[ $(btrfs property get / ro) == *true ]]
}

### Check if you are in snapshot
is_snapshot() {
	cmdline=$(</proc/cmdline)
	if [[ $cmdline =~ rootflags.*subvol=.*?/([0-9]+)/snapshot ]]; then
		return 0
	else
		return 1
	fi
}


### Main logic
require_root
require_btrfs_root

if is_btrfs_ro; then
	log "You are in the read-only Btrfs. Refresh stopped."
	exit 0
fi

if is_snapshot; then
	log "You are booted from the snapshot. Refresh stopped."
	exit 0
fi


# find the snapshot manager script
if [ -x "$SNAPSHOT_MANAGER" ]; then
    MANAGER="$SNAPSHOT_MANAGER"
else
    log "Warning: Snapshot UKI manager not found, skipping refresh"
    exit 0
fi

# check if snapshots exist
if [ ! -d "/.snapshots" ] || [ -z "$(ls -A /.snapshots 2>/dev/null)" ]; then
    log "No snapshots found in /.snapshots, skipping UKI refresh"
    exit 0
fi

log "Refreshing snapshot UKIs after snapshot updates/deletions..."

# refresh with default count (7)
if "$MANAGER" refresh 2>&1; then
    log "Snapshot UKIs refreshed successfully"
else
    log "Warning: Failed to refresh some snapshot UKIs"
    # don't fail the hook - kernel update should still succeed
fi

exit 0
